
#################### All-Reduce 

16 GPUs, ranks 0–15.
Each GPU has its own local data (let’s say a float array).

The all-reduce operation does two things:
- Reduction: it combines data from all GPUs using an operation (here sum). Example: if GPU0 has [1,2] and GPU1 has [3,4], after sum all-reduce both GPUs get [4,6].
- Distribution: every GPU ends up with the same reduced result.

So yes, all 16 GPUs participate in the exchange, but not every GPU naively sends all its data to all others. That would be extremely slow.

#################### How RCCL does it efficiently

RCCL uses optimized algorithms for multi-GPU collective communication:

- Ring-based All-Reduce (most common):

GPUs form a logical ring: 0 → 1 → 2 → ... → 15 → 0.
Each GPU sends a chunk of its data to the next GPU in the ring, while receiving a chunk from the previous GPU.
After N-1 steps (here 15), all GPUs have the sum of all data.

- Tree-based All-Reduce (sometimes used for many nodes):
GPUs are arranged in a tree.
Data is first reduced up the tree (sum at parents), then broadcast down the tree.
Reduces the number of messages across nodes.

- Chunking and pipelining:
For large arrays (like your 16 GiB test), data is split into smaller chunks.
Chunks are sent in a pipeline to overlap communication and computation.

#################### Result

kubectl logs -f mpi-multus-gfx942-launcher-l2smb

!!!!!! Add public keys of workers

Warning: Permanently added '[mpi-multus-gfx942-worker-1.mpi-multus-gfx942.default.svc]:2222' (ED25519) to the list of known hosts.
Warning: Permanently added '[mpi-multus-gfx942-worker-0.mpi-multus-gfx942.default.svc]:2222' (ED25519) to the list of known hosts.

!!!!!! 16 ranks, 1 thread per GPU

# Collective test starting: all_reduce_perf
# nThread 1 nGpus 1 minBytes 8 maxBytes 17179869184 step: 2(factor) warmup iters: 5 iters: 100 agg iters: 1 validation: 1 graph: 0
#
rccl-tests: Version develop:6405c76
# Using devices
#  Rank  0 Group  0 Pid     26 on mpi-multus-gfx942-worker-0 device  0 [0000:83:00] 
#  Rank  1 Group  0 Pid     27 on mpi-multus-gfx942-worker-0 device  1 [0000:8b:00] 
#  Rank  2 Group  0 Pid     28 on mpi-multus-gfx942-worker-0 device  2 [0000:93:00] 
#  Rank  3 Group  0 Pid     29 on mpi-multus-gfx942-worker-0 device  3 [0000:9b:00] 
#  Rank  4 Group  0 Pid     30 on mpi-multus-gfx942-worker-0 device  4 [0000:a3:00] 
#  Rank  5 Group  0 Pid     31 on mpi-multus-gfx942-worker-0 device  5 [0000:ab:00] 
#  Rank  6 Group  0 Pid     32 on mpi-multus-gfx942-worker-0 device  6 [0000:b3:00] 
#  Rank  7 Group  0 Pid     33 on mpi-multus-gfx942-worker-0 device  7 [0000:bb:00] 

#  Rank  8 Group  0 Pid     26 on mpi-multus-gfx942-worker-1 device  0 [0000:83:00] 
#  Rank  9 Group  0 Pid     27 on mpi-multus-gfx942-worker-1 device  1 [0000:8b:00] 
#  Rank 10 Group  0 Pid     28 on mpi-multus-gfx942-worker-1 device  2 [0000:93:00] 
#  Rank 11 Group  0 Pid     29 on mpi-multus-gfx942-worker-1 device  3 [0000:9b:00] 
#  Rank 12 Group  0 Pid     30 on mpi-multus-gfx942-worker-1 device  4 [0000:a3:00] 
#  Rank 13 Group  0 Pid     31 on mpi-multus-gfx942-worker-1 device  5 [0000:ab:00] 
#  Rank 14 Group  0 Pid     32 on mpi-multus-gfx942-worker-1 device  6 [0000:b3:00] 
#  Rank 15 Group  0 Pid     33 on mpi-multus-gfx942-worker-1 device  7 [0000:bb:00] 
#

!!!!!! the test will start with 8 bytes and go up to 16 GiB
!!!!!! -1 mean all-reduce to all ranks
!!!!!! redop - reduction operation sum
!!!!!! busbw - shows how fast each GPU exchanges data over PCIe/NVLink or RoCE network.


#                                                              out-of-place                       in-place          
#       size         count      type   redop    root     time   algbw   busbw #wrong     time   algbw   busbw #wrong                               
#        (B)    (elements)                               (us)  (GB/s)  (GB/s)            (us)  (GB/s)  (GB/s)                                      
           8             2     float     sum      -1    29.42    0.00    0.00      0    29.16    0.00    0.00      0
          16             4     float     sum      -1    29.09    0.00    0.00      0    29.10    0.00    0.00      0
          32             8     float     sum      -1    27.35    0.00    0.00      0    27.77    0.00    0.00      0
          64            16     float     sum      -1    27.73    0.00    0.00      0    27.74    0.00    0.00      0
         128            32     float     sum      -1    27.76    0.00    0.01      0    27.78    0.00    0.01      0
         256            64     float     sum      -1    27.72    0.01    0.02      0    27.94    0.01    0.02      0
         512           128     float     sum      -1    28.59    0.02    0.03      0    28.52    0.02    0.03      0
        1024           256     float     sum      -1    29.63    0.03    0.06      0    29.12    0.04    0.07      0
        2048           512     float     sum      -1    31.38    0.07    0.12      0    31.93    0.06    0.12      0
        4096          1024     float     sum      -1    33.27    0.12    0.23      0    32.41    0.13    0.24      0
        8192          2048     float     sum      -1    33.53    0.24    0.46      0    32.75    0.25    0.47      0
       16384          4096     float     sum      -1    33.61    0.49    0.91      0    33.34    0.49    0.92      0
       32768          8192     float     sum      -1    33.53    0.98    1.83      0    33.65    0.97    1.83      0
       65536         16384     float     sum      -1    35.74    1.83    3.44      0    36.04    1.82    3.41      0
      131072         32768     float     sum      -1    38.76    3.38    6.34      0    38.30    3.42    6.42      0
      262144         65536     float     sum      -1    46.86    5.59   10.49      0    45.03    5.82   10.92      0
      524288        131072     float     sum      -1    58.83    8.91   16.71      0    59.44    8.82   16.54      0
     1048576        262144     float     sum      -1    70.48   14.88   27.90      0    69.55   15.08   28.27      0
     2097152        524288     float     sum      -1    83.72   25.05   46.97      0    82.50   25.42   47.66      0
     4194304       1048576     float     sum      -1    100.3   41.83   78.44      0    100.9   41.55   77.91      0
     8388608       2097152     float     sum      -1    189.8   44.20   82.88      0    191.3   43.86   82.24      0
    16777216       4194304     float     sum      -1    254.3   65.96  123.68      0    264.1   63.54  119.13      0
    33554432       8388608     float     sum      -1    391.7   85.66  160.62      0    394.7   85.01  159.39      0
    67108864      16777216     float     sum      -1    600.0  111.85  209.73      0    602.9  111.30  208.69      0
   134217728      33554432     float     sum      -1    859.0  156.25  292.96      0    855.1  156.96  294.31      0
   268435456      67108864     float     sum      -1   1467.3  182.95  343.03      0   1464.8  183.25  343.60      0
   536870912     134217728     float     sum      -1   2864.5  187.42  351.41      0   2845.1  188.70  353.82      0
  1073741824     268435456     float     sum      -1   5752.3  186.66  349.99      0   5706.9  188.15  352.77      0
  2147483648     536870912     float     sum      -1    11390  188.54  353.51      0    11388  188.58  353.58      0
  4294967296    1073741824     float     sum      -1    22678  189.39  355.11      0    22695  189.24  354.83      0
  8589934592    2147483648     float     sum      -1    45161  190.21  356.64      0    45165  190.19  356.61      0
 17179869184    4294967296     float     sum      -1    89998  190.89  357.92      0    90035  190.81  357.78      0

!!!!!! No errors occurred (#wrong=0 for all sizes). ✅
!!!!!! Average bus bandwidth across all tests: 110.36 GB/s.

# Errors with asterisks indicate errors that have exceeded the maximum threshold.
# Out of bounds values : 0 OK
# Avg bus bandwidth    : 110.36 
#
# Collective test concluded: all_reduce_perf
